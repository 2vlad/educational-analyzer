# –ì–æ—Ç–æ–≤–æ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–µ–ø–ª–æ—é (—á–µ—Ä–µ–∑ ~8 —á–∞—Å–æ–≤)

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω OPENROUTER_API_KEY –≤ Vercel

- –ù–æ–≤—ã–π –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Vercel environment variables
- –ë—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –¥–µ–ø–ª–æ–µ

### 2. –£–ª—É—á—à–µ–Ω fallback –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è coherence analysis

- **–û—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å:** OpenRouter ‚Üí Claude Sonnet 4 (–∫–æ–≥–¥–∞ OPENROUTER_API_KEY –¥–æ—Å—Ç—É–ø–µ–Ω)
- **Fallback –ø—É—Ç—å:** –ü—Ä—è–º–æ–π OpenAI GPT-4 (–µ—Å–ª–∏ OpenRouter –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
- **–†–∞–Ω—å—à–µ –±—ã–ª:** Yandex (–≤–æ–∑–≤—Ä–∞—â–∞–ª –Ω–µ –≤–∞–ª–∏–¥–Ω—ã–π JSON)

### 3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ–º–ø—Ç –¥–ª—è coherence analysis

```typescript
// –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ JSON –æ—Ç–≤–µ—Ç–∞
const coherencePrompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–≤—è–∑–Ω–æ—Å—Ç—å –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å N —É—Ä–æ–∫–æ–≤.

–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –æ–±—ä–µ–∫—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.

–§–æ—Ä–º–∞—Ç:
{
  "score": —á–∏—Å–ª–æ –æ—Ç -2 –¥–æ 2,
  "summary": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
  "strengths": ["—Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ 1"],
  "issues": ["–ø—Ä–æ–±–ª–µ–º–∞ 1"],
  "suggestions": ["—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1"]
}
...`
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
- –í–∏–¥–Ω–æ –∫–∞–∫–æ–π provider –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- –ü–æ–Ω—è—Ç–Ω—ã –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞

## üìã –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å OPENROUTER_API_KEY

```bash
curl https://edu-ai-student-4.vercel.app/api/debug-env | jq '.envVars.OPENROUTER_API_KEY'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
"SET (length: XX, starts: sk-or-v1-...)"
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health endpoint

```bash
curl https://edu-ai-student-4.vercel.app/api/health | jq '.checks.env'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```json
{
  "hasAnthropicKey": true,
  "hasOpenRouterKey": true, // ‚Üê –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true!
  "hasSupabaseUrl": true,
  "hasSupabaseKey": true,
  "hasSupabaseServiceKey": true,
  "hasYandexKey": true,
  "defaultModel": "yandex-gpt-pro"
}
```

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å coherence analysis

```bash
curl -X POST "https://edu-ai-student-4.vercel.app/api/analyze-coherence" \
  -H "Content-Type: application/json" \
  -d '{
    "lessons": [
      {
        "title": "JavaScript Variables",
        "content": "–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –∏–∑—É—á–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ JavaScript. –†–∞—Å—Å–º–æ—Ç—Ä–∏–º let, const –∏ var. –ü–æ–Ω–∏–º–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è."
      },
      {
        "title": "JavaScript Functions",
        "content": "–ü—Ä–æ–¥–æ–ª–∂–∞—è –∏–∑—É—á–µ–Ω–∏–µ JavaScript, —Ä–∞–∑–±–µ—Ä–µ–º —Ñ—É–Ω–∫—Ü–∏–∏. –§—É–Ω–∫—Ü–∏–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –∫–æ–¥ –≤ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±–ª–æ–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É—Ä–æ–∫–∞."
      }
    ]
  }' | jq '.'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```json
{
  "success": true,
  "analysis": {
    "score": 1, // —á–∏—Å–ª–æ –æ—Ç -2 –¥–æ 2
    "summary": "–£—Ä–æ–∫–∏ —Ö–æ—Ä–æ—à–æ —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π...",
    "strengths": ["–õ–æ–≥–∏—á–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "..."],
    "issues": ["–ú–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–±–æ–ª—å—à–∏–µ –ø—Ä–æ–±–µ–ª—ã", "..."],
    "suggestions": ["–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã", "..."]
  }
}
```

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: OpenRouter –¥–æ—Å—Ç—É–ø–µ–Ω (–æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å) ‚úÖ

```
1. User request ‚Üí /api/analyze-coherence
2. LLMService checks OPENROUTER_API_KEY ‚Üí ‚úÖ Available
3. Uses Claude Sonnet 4 via OpenRouter
4. Returns JSON analysis ‚Üí Success!
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: OpenRouter –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (fallback) ‚ö†Ô∏è

```
1. User request ‚Üí /api/analyze-coherence
2. LLMService checks OPENROUTER_API_KEY ‚Üí ‚ùå Not available
3. Falls back to OpenAI GPT-4 (direct API)
4. Uses gpt-4o model
5. Returns JSON analysis ‚Üí Success!
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–±–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã (–æ—á–µ–Ω—å —Ä–µ–¥–∫–æ) ‚ùå

```
1. User request ‚Üí /api/analyze-coherence
2. Both providers fail
3. Returns error with details
```

## üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### Production (Vercel)

```
‚úÖ ANTHROPIC_API_KEY     - Available (length: 108)
‚úÖ OPENAI_API_KEY        - Available (length: 164)
‚úÖ YANDEX_API_KEY        - Available (length: 41)
‚úÖ SUPABASE_*            - All available
‚è≥ OPENROUTER_API_KEY    - Updated, waiting for deploy
```

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è coherence analysis –¥–æ–ª–∂–µ–Ω:

1. ‚úÖ **–†–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ** —á–µ—Ä–µ–∑ OpenRouter (Claude Sonnet 4)
2. ‚úÖ **–ò–º–µ—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–π fallback** –Ω–∞ OpenAI GPT-4
3. ‚úÖ **–í–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π JSON** –≤ –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö
4. ‚úÖ **–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏** –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫

## üìù –ö–æ–º–º–∏—Ç—ã

```bash
3b7f951 Switch coherence analysis fallback from Yandex to OpenAI GPT-4
62b8d0f Deploy coherence analysis improvements
a141e7b Improve coherence analysis prompt and logging for Yandex
9321cc7 Force deploy with updated debug endpoint
ed369f6 Debug: show more env variable details
```

## üêõ –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ–±–ª–µ–º–∞: OPENROUTER_API_KEY –≤—Å–µ –µ—â–µ NOT SET

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Vercel dashboard: Settings ‚Üí Environment Variables
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è Production
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω–æ–≤–æ

### –ü—Ä–æ–±–ª–µ–º–∞: Coherence analysis –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É

**–î–µ–π—Å—Ç–≤–∏—è:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Vercel: `vercel logs <deployment-url>`
2. –ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å `[Coherence Analysis]`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–∫–æ–π provider –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM –≤ –ª–æ–≥–∞—Ö

### –ü—Ä–æ–±–ª–µ–º–∞: JSON –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

- –í –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM
- –ï—Å–ª–∏ OpenAI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å—Ç—ã–º
- –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è, –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –≤ –ø—Ä–æ–º–ø—Ç–µ

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–µ–π—á–∞—Å:** –ñ–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–µ–ø–ª–æ—è (~8 —á–∞—Å–æ–≤)
2. **–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:** –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ 3 —Ç–µ—Å—Ç–∞ –≤—ã—à–µ
3. **–ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç:** –£–¥–∞–ª—è–µ–º debug endpoint (`/api/debug-env`)
4. **–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:** –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏ –∏ –¥–µ–±–∞–∂–∏–º –¥–∞–ª—å—à–µ

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-12  
**–°—Ç–∞—Ç—É—Å:** –û–∂–∏–¥–∞–µ—Ç –¥–µ–ø–ª–æ—è  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π
